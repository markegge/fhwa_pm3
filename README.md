# NPMRDS Travel Time Reliability Processing Tools

NPMRDS Travel Time data is genearlly too voluminous to be effectively managed or manipulated using "common" desktop tools such as Microsoft Excel or Tableau. This repository provides some scripts and tools written in R for effectively working with voluminous NPMRDS data, especially for the purposes of calculating the FHWA PM3 System Reliability and Freight Performance TPM Performance Measures.

This package: 

* Create Level of Travel Time Reliability (LOTTR) and Truck Travel Time Reliability (TTTR) metric scores
* Generate an HPMS Submittal File based on the [HPMS Field Manual Supplemental Guidance](https://www.fhwa.dot.gov/tpm/guidance/pm3_hpms.pdf)


## Installation

```r
library(devtools)
devtools::install_github("markegge/fhwa_pm3")
library(pm3)
```

## Calculating LOTTR and TTTR Metric Scores

To calculate LOTTR or TTTR Metric scores:

1. Download the shapefiles for the desired year(s) from [https://npmrds.ritis.org/analytics/shapefiles](https://npmrds.ritis.org/analytics/shapefiles)

2. Generate TMC List with the `tmc_list` function:

### All TMCs in Shapefile

```R
# Exports comma separated list of all TMCs
tmc_list(infile = "shp/Utah/Utah.shp", outfile = "out/tmcs.txt")
```

### Interstate TMCs Only

```R
library(pm3)
# Exports comma separated list of Interstate TMCs for TTTR calculations
tmc_list(infile = "shp/Utah/Utah.shp", 
         tmcs = "interstate", 
         outfile = "out/tmcs_interstate.txt")
```

3. Log in to RITIS [https://npmrds.ritis.org/analytics/](https://npmrds.ritis.org/analytics/)
4. Go to Massive Data Downloader
5. Choose the appropriate "TMC segments from" value (e.g. "NPMRDS INRIX 2019")
6. Paste in list of TMCs Segment Codes generated by `tmc_list` and click Add
7. Specify appropriate date range, e.g 01/01/2019 â€“ 12/31/2019
8. Select data sources and measures: 
    * "NPMRDS form INRIX (Trucks and Passenger Vehicles): Travel Time" for LOTTR Measure (uncheck Speed, Historic average speed, Reference speed, and Data Density)
    * "NPMRDS from Inrix (Trucks): Travel Time" for TTTR Measure (uncheck Speed, Historic average speed, Reference speed, and Data Density)
9. Set averaging to 15 minutes (per PM3 Final Rule)
10. Download and extract the resulting dataset
11. Calculate scores using `score` 

```R
# Calculate monthly TTTR metric scores
tttr_scores <- score("data/Trucks/Readings.csv", 
                     metric = "TTTR", 
                     period = "monthly", 
                     verbose = TRUE)
```

### A Minimal Example

```R
library(data.table)
library(pm3)

# Read in TMC attributes from RITIS export
tmcs <- fread("data/TMC_Identification.csv")

# Caclulate segment-level LOTTR scores
tmc_scores <- score("data/Readings.csv", metric = "LOTTR")

# Merge the tmc_scores table to the tmcs attribute table
tmcs <- merge(tmcs, tmc_scores, by.x = "tmc", by.y= "tmc_code")

tmcs[, vmt := ifelse(faciltype == 1, 1.0, 0.5) * aadt * miles * nhs_pct * 0.01]
tmcs[, system := ifelse(f_system == 1, "Interstate", "Non-Interstate NHS")]

# Calculate LOTTR scores
tmcs[!is.na(vmt), sum(vmt * reliable) / sum(vmt), by = system]
```

### A Full Example

```R
library(data.table)
library(pm3)
library(sf)

shp_2017 <- st_read("shp/Wyoming_2017/Wyoming.shp", stringsAsFactors = FALSE)
shp_2018 <- st_read("shp/Wyoming_2018/Wyoming.shp", stringsAsFactors = FALSE)
shp_2019 <- st_read("shp/Wyoming_2019/Wyoming.shp", stringsAsFactors = FALSE)

shp_2017$year <- 2017
shp_2018$year <- 2018
shp_2019$year <- 2019

# Generate TMC Lists for RITIS Download --------------------------------------
tmc_list("shp/Wyoming_2017/Wyoming.shp", outfile = "out/tmcs_2017.txt")
tmc_list("shp/Wyoming_2018/Wyoming.shp", outfile = "out/tmcs_2018.txt")
tmc_list("shp/Wyoming_2019/Wyoming.shp", outfile = "out/tmcs_2019.txt")

tmc_list("shp/Wyoming_2017/Wyoming.shp", tmcs = "interstate", outfile = "out/tmcs_interstate_2017.txt")
tmc_list("shp/Wyoming_2018/Wyoming.shp", tmcs = "interstate", outfile = "out/tmcs_interstate_2018.txt")
tmc_list("shp/Wyoming_2019/Wyoming.shp", tmcs = "interstate", outfile = "out/tmcs_interstate_2019.txt")

#
#  ** DOWNLOAD AND EXTRACT NPMRDS DATA BASED ON TMC LISTS FROM PREVIOUS STEP **
#  ** Update paths below appropriately... **
#


# LOTTR --------------------------------------------------------
lottr_2017 <- score("data/wy_2017/Readings.csv", metric = "LOTTR")
lottr_2018 <- score("data/wy_2018/Readings.csv", metric = "LOTTR")
lottr_2019 <- score("data/wy_2019/Readings.csv", metric = "LOTTR")

lottr_2017 <- merge(st_drop_geometry(shp_2017), lottr_2017, by.x = "Tmc", by.y = "tmc_code")
lottr_2018 <- merge(st_drop_geometry(shp_2018), lottr_2018, by.x = "Tmc", by.y = "tmc_code")
lottr_2019 <- merge(st_drop_geometry(shp_2019), lottr_2019, by.x = "Tmc", by.y = "tmc_code")

lottr <- rbindlist(list(lottr_2017, lottr_2018, lottr_2019))
setDT(lottr)

lottr[, nhs_miles := Miles * NHS_Pct * 0.01]
lottr[, vmt := AADT * ifelse(FacilType == 1, 1.0, 0.5) * nhs_miles]
lottr[, system := ifelse(F_System == 1, "Interstate", "Non-Interstate NHS")]

# LOTTR Score 
lottr[vmt >= 0 & !is.na(reliable), 
      .(pct_reliable = sum(vmt * reliable) / sum(vmt)),
      by = .(system, year)]


# TTTR ----------------------------------------------------------
tttr_2017 <- score("data/wy_trucks_2018/Readings.csv", metric = "TTTR")
tttr_2018 <- score("data/wy_trucks_2018/Readings.csv", metric = "TTTR")
tttr_2019 <- score("data/wy_trucks_2019/Readings.csv", metric = "TTTR")

tttr_2017 <- merge(st_drop_geometry(shp_2017), tttr_2017, by.x = "Tmc", by.y = "tmc_code")
tttr_2018 <- merge(st_drop_geometry(shp_2018), tttr_2018, by.x = "Tmc", by.y = "tmc_code")
tttr_2019 <- merge(st_drop_geometry(shp_2019), tttr_2019, by.x = "Tmc", by.y = "tmc_code")

tttr <- rbindlist(list(tttr_2017, tttr_2018, tttr_2019))
setDT(tttr)

tttr[, nhs_miles := Miles * NHS_Pct * 0.01]

# TTTR Score
tttr[F_System == 1, .(tttr_index = sum(max_tttr * nhs_miles) / sum(nhs_miles)), by = year]

```

## Creating an HPMS Submittal File

The `hpms()` function outputs a .txt file in the appropriate format for HPMS submission. See the (HPMS Supplemental Guidance for PM3)[https://www.fhwa.dot.gov/tpm/guidance/pm3_hpms.pdf]

Note, the input scores *must* be generated with verbose = TRUE.

```R
shp <- st_read("shp/Wyoming_2019/Wyoming.shp", stringsAsFactors = FALSE)
lottr <- score("data/All_Vehicles/Readings.csv", metric = "LOTTR", verbose = TRUE)
tttr <- score("data/Trucks/Readings.csv", metric = "TTTR", verbose = TRUE)
hpms(shp, lottr, tttr)
```


## PM3 Guidance

The PM3 Performance measures are best described in [FHWA's June 1, 2017 PM3 Webinar Presentation](https://www.fhwa.dot.gov/tpm/rule/170601pm3.pdf)

FWHA has also provided two sets of guidance on calculating the LOTTR and TTTR performance metrics:

* [General Guidance and Step-by-Step Metric Calculation Procedures for National Performance Measures for Congestion, Reliability, and Freight, and CMAQ Traffic Congestion](https://www.fhwa.dot.gov/tpm/guidance/hif18040.pdf) 
* [FHWA Computation Procedure for Travel Time Based and Percent Non-Single Occupancy Vehicle (non-SOV) Travel Performance Measures](https://www.fhwa.dot.gov/tpm/guidance/hif18024.pdf)

You can also reference the definitive [Federal Register PM3 Final Rule](https://www.federalregister.gov/documents/2018/05/31/2018-11652/national-performance-management-measures-assessing-performance-of-the-national-highway-system).

## TMC Network and Traffic Volumes

Each year the TMC network is updated. This reflects improvements in TTI's conflation methodolgies, corrections submitted by users, as well as changes in the underlying attribute data.

The NPMRDS TMC network is a set of INRIX/HERE TMC segments to which selected HPMS attribtues have been conflated. There is a *two year lag* between the TMC network and the HPMS data. For example, the 2019 NPMRDS TMC network reflects AADT values based on 2017 HPMS. Since FHWA only requires traffic counts once every three years, some AADT values reported in the 2019 NPRMDS TMC network may be based on 2014 traffic counts. The NPMRDS reported AADT values should be calculating PM3 Performance Measures, but for other analysis it is better to use more recent sources of traffic counts. 

For a method for estimating order-of-magnitude traffic volumes using NPMRDS data itself, see [this repository](https://bitbucket.org/high-street/npmrds_probe_counts/).

## Attribution

Package author: Mark Egge, High Street (egge@highstreetconsulting.com)